<!DOCTYPE html>
<html lang="en" xmlns:v-slot="http://www.w3.org/1999/XSL/Transform">
<head>
    <meta charset="UTF-8">
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css"/>
    <title>file bed</title>
</head>
<body>
<div class="container">

    <b-input-group id="loginForm">
        <b-form-input size="sm" type="password" placeholder="token" v-model="token"></b-form-input>
        <b-button size="sm" variant="outline-primary" :disabled="logining" @click="login">login</b-button>
    </b-input-group>

    <br/>

    <form id="uploadForm">
        <b-input-group>
            <b-form-file size="sm" v-model="file"></b-form-file>
            <b-form-input size="sm" type="text" placeholder="sort" v-model="sort"></b-form-input>
        </b-input-group>
        <b-input-group>
            <b-form-input size="sm" type="text" placeholder="filePath" v-model="filePath"></b-form-input>
            <b-button size="sm" variant="outline-primary" :disabled="fileUploading" @click="uploadFile">upload
            </b-button>
        </b-input-group>
        <br/>
        <b-input-group>
            <b-form-input size="sm" type="text" placeholder="url" v-model="url"></b-form-input>
            <b-form-input size="sm" type="text" placeholder="sort" v-model="sort"></b-form-input>
        </b-input-group>
        <b-input-group>
            <b-form-input size="sm" type="text" placeholder="filePath" v-model="filePath"></b-form-input>
            <b-button size="sm" variant="outline-primary" :disabled="urlUploading" @click="uploadUrl">upload</b-button>
        </b-input-group>
    </form>

    <br/>

    <div id="lastFileInfo">
        <b-table responsive stacked small striped :busy="loading" :fields="fields" :items="fileInfos">
            <template v-slot:cell(name)="data">
                <a :target="data.item.mime!=''?'_blank':''" :href="data.item.mime!=''?data.item.url:'javascript:;'"
                   @click="openFile(data.index)">{{data.item.name}}</a>
            </template>
            <template v-slot:cell(url)="data">
                <b-form-input size="sm" type="text" placeholder="url" v-if="data.item.mime!=''"
                              :value="window.location.protocol+'//'+window.location.host+data.item.url"></b-form-input>
            </template>
            <template v-slot:cell(delete)="data">
                <b-button size="sm" variant="outline-danger" v-if="data.item.mime!=''" @click="deleteFile(data.index)">
                    delete
                </b-button>
            </template>

            <template v-slot:table-busy>
                <div class="text-center text-danger my-2">
                    <b-spinner class="align-middle"></b-spinner>
                    <strong>Loading...</strong>
                </div>
            </template>
        </b-table>
    </div>


    <form id="synForm">
        <b-input-group>
            <b-form-input size="sm" type="text" placeholder="pushSynHost" v-model="pushSynHost"></b-form-input>
            <b-form-input size="sm" type="password" placeholder="token" v-model="token"></b-form-input>
            <b-button size="sm" variant="outline-primary" :disabled="pushing" @click="pushSynFile">push syn</b-button>
        </b-input-group>
        <b-input-group>
            <b-form-input size="sm" type="text" placeholder="pullSynHost" v-model="pullSynHost"></b-form-input>
            <b-form-input size="sm" type="password" placeholder="token" v-model="token"></b-form-input>
            <b-button size="sm" variant="outline-primary" :disabled="pulling" @click="pullSynFile">pull syn</b-button>
        </b-input-group>
    </form>


    <div class="table-responsive" id="folderTable">

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item" v-for="(breadcrumb, index) in breadcrumbs"
                    @click="breadcrumbGo(index)"><a href="javascript:;">{{breadcrumb.name}}</a></li>
            </ol>
        </nav>

        <b-table responsive small striped :busy="loading" :fields="fields" :items="fileInfos">
            <template v-slot:cell(name)="data">
                <a :target="data.item.isFile?'_blank':''" :href="data.item.isFile?data.item.url:'javascript:;'"
                   @click="openFile(data.index)">{{data.item.name}}</a>
            </template>
            <template v-slot:cell(url)="data">
                <b-form-input size="sm" type="text" placeholder="url" v-if="data.item.isFile"
                              :value="window.location.protocol+'//'+window.location.host+data.item.url"></b-form-input>
            </template>
            <template v-slot:cell(delete)="data">
                <b-button size="sm" variant="outline-danger" v-if="data.item.isFile" @click="deleteFile(data.index)">
                    delete
                </b-button>
            </template>

            <template v-slot:table-busy>
                <div class="text-center text-danger my-2">
                    <b-spinner class="align-middle"></b-spinner>
                    <strong>Loading...</strong>
                </div>
            </template>
        </b-table>
    </div>

</div>
<script src="//unpkg.com/vue@latest/dist/vue.min.js"></script>
<script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
<script src="https://cdn.bootcss.com/qs/6.8.0/qs.min.js"></script>
<script src="//cdn.bootcss.com/axios/0.19.0-beta.1/axios.min.js"></script>

<script>
    // window.onbeforeunload = (event) => 'maybe some data not save'

    var instance = axios.create({timeout: 60 * 60 * 1000});

    const loginVue = new Vue({
        el: '#loginForm',
        data: {
            token: null,
            logining: false,
        },
        methods: {
            login: function () {
                if (this.token == null || this.token == "") {
                    this.token = ""
                    alert('token is empty')
                    return
                }
                loginVue.logining = true
                instance.post("/login", Qs.stringify({token: this.token}))
                    .then(response => {
                        loginVue.logining = false
                        const result = response.data
                        alert(JSON.stringify(result))
                        if (result.code == 1) {
                            this.token = null
                            lastFileInfoVue.listLastFileInfo()
                            folderVue.listFolderInfo()
                        }
                    })
                    .catch(error => {
                        loginVue.logining = false
                        alert("error: " + JSON.stringify(error))
                    })
            }
        }
    })

    const uploadFileVue = new Vue({
        el: '#uploadForm',
        data: {
            filePath: null,
            sort: null,
            url: null,
            file: null,
            fileUploading: false,
            urlUploading: false,
        },
        methods: {
            uploadFile: function () {
                if (this.file == null) {
                    alert('file is empty')
                    return
                }
                if (this.filePath == null || this.filePath == '') {
                    this.filePath = createFilePath(this.sort, this.file.name)
                    return
                }
                const param = new FormData()
                param.append("filePath", this.filePath)
                param.append("file", this.file)
                uploadFileVue.fileUploading = true
                instance.post("/admin/uploadFile", param, {headers: {'Content-Type': 'multipart/form-data'}})
                    .then(response => {
                        uploadFileVue.fileUploading = false
                        const result = response.data
                        alert(JSON.stringify(result))
                        if (result.code == 1) {
                            this.filePath = null
                            this.file = null
                            lastFileInfoVue.listLastFileInfo()
                        }
                    })
                    .catch(error => {
                        uploadFileVue.fileUploading = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
            uploadUrl: function () {
                if (this.file == null) {
                    alert('file is empty')
                    return
                }
                if (this.filePath == null || this.filePath == '') {
                    this.filePath = createFilePath(this.sort, this.file.filename)
                    return
                }
                uploadFileVue.urlUploading = true
                instance.post("/admin/uploadUrl", Qs.stringify({filePath: this.filePath, url: this.url}))
                    .then(response => {
                        uploadFileVue.urlUploading = false
                        const result = response.data
                        alert(JSON.stringify(result))
                        if (result.code == 1) {
                            this.filePath = null
                            this.url = null
                            lastFileInfoVue.listLastFileInfo()
                        }
                    })
                    .catch(error => {
                        uploadFileVue.urlUploading = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
        }
    })

    const lastFileInfoVue = new Vue({
        el: '#lastFileInfo',
        data: {
            fields: [
                {
                    key: 'name',
                    label: 'name',
                    sortable: true,
                },
                {
                    key: 'size',
                    label: 'size',
                    sortable: true,
                },
                {
                    key: 'md5',
                    label: 'md5',
                    sortable: true,
                },
                {
                    key: 'url',
                    label: 'url',
                },
                {
                    key: 'delete',
                    label: 'delete',
                },
            ],
            fileInfos: [],
            loading: false,
        },
        methods: {
            listLastFileInfo: function () {
                this.loading = true
                instance.get("/admin/listLastFileInfo", {params: {}})
                    .then(function (response) {
                        this.loading = false
                        const result = response.data
                        if (result.code != 1) {
                            alert(JSON.stringify(result))
                            return
                        }
                        if (result.data == null) {
                            return
                        }
                        this.fileInfos = result.data
                        for (let i = 0; i < this.fileInfos.length; i++) {
                            this.fileInfos[i] = formatFileOrFolderInfo(this.fileInfos[i])
                        }
                    })
                    .catch(error => {
                        folderVue.loading = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
            deleteFile: function (index) {
                deleteFile(this.fileInfos, index)
            },
        }
    })

    const synVue = new Vue({
        el: '#synForm',
        data: {
            pushSynHost: null,
            pullSynHost: null,
            token: null,
            pushing: false,
            pulling: false,
        },
        methods: {
            pushSynFile: function () {
                if (this.pushSynHost == null || this.pushSynHost == "") {
                    alert('pushSynHost is empty')
                    return
                }
                if (this.token == null || this.token == "") {
                    alert('token is empty')
                    return
                }
                this.pushing = true
                instance.post("/admin/pushSynFile", Qs.stringify({pushSynHost: this.pushSynHost, token: this.token}))
                    .then(response => {
                        synVue.pushing = false
                        const result = response.data
                        alert('push syn ' + (result.code == 1 ? 'success' : 'fail') +
                            '\nmassage: ' + result.massage +
                            '\nfail count: ' + result.data.failCount +
                            '\nerr: ' + JSON.stringify(result.data.err))
                    })
                    .catch(error => {
                        synVue.pushing = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
            pullSynFile: function () {
                if (this.pullSynHost == null || this.pullSynHost == "") {
                    this.pullSynHost = ""
                    alert('pullSynHost is empty')
                    return
                }
                if (this.token == null || this.token == "") {
                    this.token = ""
                    alert('token is empty')
                    return
                }
                this.pulling = true
                instance.post("/admin/pullSynFile", Qs.stringify({pullSynHost: this.pullSynHost, token: this.token}))
                    .then(response => {
                        synVue.pulling = false
                        const result = response.data
                        alert('pull syn ' + (result.code == 1 ? 'success' : 'fail') +
                            '\nmassage: ' + result.massage +
                            '\nfail count: ' + result.data.failCount +
                            '\nerr: ' + JSON.stringify(result.data.err))
                    })
                    .catch(error => {
                        synVue.pulling = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
        }
    })

    const folderVue = new Vue({
        el: '#folderTable',
        data: {
            currentPath: "",
            breadcrumbs: [
                {name: "root", path: ""},
            ],
            fileInfos: [],
            fields: [
                {
                    key: 'name',
                    label: 'name',
                    sortable: true,
                },
                {
                    key: 'size',
                    label: 'size',
                    sortable: true,
                },
                {
                    key: 'url',
                    label: 'url',
                },
                {
                    key: 'delete',
                    label: 'delete',
                },
            ],
            loading: false,
            allCacheClearing: false,
        },
        methods: {
            breadcrumbGo: function (index) {
                this.gotoFolder(this.breadcrumbs[index].path)
            },
            openFile: function (index) {
                var fileInfo = this.fileInfos[index]
                if (fileInfo.isFile) {
                    return
                }
                this.gotoFolder(fileInfo.path)
            },
            setBreadcrumb: function () {
                const paths = this.currentPath.split("/")
                this.breadcrumbs = [{name: "root", path: ""}]
                let fatherBreadcrumbIndex = 0
                for (let i = 0; i < paths.length; i++) {
                    if (paths[i] == null || paths[i] == "") {
                        continue
                    }
                    this.breadcrumbs.push({
                        name: paths[i],
                        path: this.breadcrumbs[fatherBreadcrumbIndex].path + "/" + paths[i]
                    })
                    fatherBreadcrumbIndex++
                }
            },
            listFolderInfo: function () {
                this.loading = true
                instance.get("/admin/listFolderInfo", {params: {folderPath: this.currentPath}})
                    .then(function (response) {
                        folderVue.loading = false
                        const result = response.data
                        if (result.code != 1) {
                            alert(result.massage)
                            return
                        }
                        if (result.data == null || result.data.length == 0) {
                            alert("this has not file or folder")
                            result.data = []
                        }
                        folderVue.fileInfos = result.data
                        folderVue.fileInfos.sort((info1, info2) => {
                            if (info1.isFile != info2.isFile) {
                                return !info1.isFile ? -1 : 1
                            }
                            return info1.path - info2.path
                        })
                        for (let i = 0; i < folderVue.fileInfos.length; i++) {
                            folderVue.fileInfos[i] = formatFileOrFolderInfo(folderVue.fileInfos[i])
                        }
                    })
                    .catch(error => {
                        folderVue.loading = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
            gotoFolder: function (path) {
                this.currentPath = path
                this.setBreadcrumb()
                this.listFolderInfo()
            },
            deleteFile: function (index) {
                deleteFile(this.fileInfos, index)
            },
            clearAllCache: function () {
                if (!window.confirm("sure clear all cache ?!?")) {
                    return
                }
                folderVue.allCacheClearing = true
                instance.post("/admin/clearAllCache", Qs.stringify({}))
                    .then(response => {
                        folderVue.allCacheClearing = false
                        const result = response.data
                        alert(result.massage)
                        if (result.code == 1) {
                            this.listFolderInfo()
                        }
                    })
                    .catch(error => {
                        folderVue.allCacheClearing = false
                        alert("error: " + JSON.stringify(error))
                    })
            },
        }
    })

    function deleteFile(fileInfos, index) {
        if (fileInfos[index].mime == null || fileInfos[index].mime == '') {
            window.alert("not file")
            return
        }
        if (!window.confirm("sure delete file ?!?: " + fileInfos[index].path)) {
            return
        }
        instance.post("/admin/removeFile", Qs.stringify({filePath: fileInfos[index].path}))
            .then(response => {
                const result = response.data
                alert(JSON.stringify(result))
                if (result.code == 1) {
                    fileInfos.splice(index, 1)
                }
            })
            .catch(error => alert("error: " + JSON.stringify(error)))
    }

    function formatFileOrFolderInfo(fileOrFolderInfo) {
        fileOrFolderInfo.size = formatFileSize(fileOrFolderInfo.fileSize)
        fileOrFolderInfo.url = encodeURI(fileOrFolderInfo.url)
        return fileOrFolderInfo
    }

    function formatFileSize(bytes) {
        if (bytes < 0) {
            return '非法大小: ' + bytes
        }
        if (bytes == 0) {
            return '0 B'
        }
        var s = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
        var e = Math.floor(Math.log(bytes) / Math.log(1024));
        return (bytes / Math.pow(1024, Math.floor(e))).toFixed(2) + "" + s[e];
    }


    function createFilePath(sort, filename) {
        return sort + '/' + formatDate(new Date(), 'yyyyMMdd') + '/' + filename
    }

    function formatDate(date, fmt) {
        let o = {
            'M+': date.getMonth() + 1, //月份
            'd+': date.getDate(), //日
            'h+': date.getHours(), //小时
            'm+': date.getMinutes(), //分
            's+': date.getSeconds(), //秒
            'q+': Math.floor((date.getMonth() + 3) / 3), //季度
            'S': date.getMilliseconds() //毫秒
        }
        if (/(y+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (date.getFullYear() + '').substr(4 - RegExp.$1.length))
        }
        for (let k in o) {
            if (new RegExp('(' + k + ')').test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1)
                    ? (o[k]) : (('00' + o[k]).substr(('' + o[k]).length)))
            }
        }
        return fmt
    }
</script>
</body>
</html>